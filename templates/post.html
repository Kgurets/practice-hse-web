<!DOCTYPE html>
<html>
<head>
    <title>{{ post.title }}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .post-content { line-height: 1.6; margin: 20px 0; }
        .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        .btn { padding: 8px 16px; text-decoration: none; border-radius: 5px; margin-right: 8px; border: none; cursor: pointer; font-size: 14px; display: inline-block; }
        .btn-primary { background: #ff69b4; color: white; }
        .btn-secondary { background: #ffb6c1; color: #333; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .comments { margin-top: 30px; }
        .comment { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .comment-meta { color: #666; font-size: 0.8em; }
        .comment-form { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 4px; }
        .comment-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .categories { margin: 10px 0; }
        .category-tag { background: #e9ecef; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; margin-right: 8px; display: inline-block; margin-bottom: 5px; }
        .actions { margin: 15px 0; }
        .subscription-section { margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 4px; }
        .favorites-section { margin: 20px 0; padding: 15px; background: #fff0f5; border-radius: 4px; }
    </style>
</head>
<body>
    <a href="/" class="btn btn-primary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    
    <h1>{{ post.title }}</h1>
    <div class="meta">
        –ê–≤—Ç–æ—Ä: {{ author_name }} | 
        –°–æ–∑–¥–∞–Ω: {{ post.created_at[:16] }} |
        –û–±–Ω–æ–≤–ª–µ–Ω: {{ post.updated_at[:16] }}
    </div>

    <div class="categories">
        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong>
        <div id="postCategories">
            {% for category in post.categories %}
            <span class="category-tag">{{ category.name }}</span>
            {% else %}
            <span>–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</span>
            {% endfor %}
        </div>
    </div>

    <div class="post-content">
        {{ post.content }}
    </div>
    
    <div class="actions">
        <a href="/posts/edit/{{ post.id }}" class="btn btn-secondary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
    </div>

    <div class="favorites-section">
        <h3>üíñ –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</h3>
        <select id="favoriteUser" style="margin-right: 10px; padding: 5px;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
            {% for user in users %}
            <option value="{{ user.id }}">{{ user.login }}</option>
            {% endfor %}
        </select>
        <button onclick="addToFavorites('{{ post.id }}')" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
    </div>

    <div class="subscription-section">
        <h3>üîî –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∞–≤—Ç–æ—Ä–∞</h3>
        <select id="subscriberUser" style="margin-right: 10px; padding: 5px;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞</option>
            {% for user in users %}
            <option value="{{ user.id }}">{{ user.login }}</option>
            {% endfor %}
        </select>
        <button onclick="subscribeToAuthor('{{ post.author_id }}')" class="btn btn-warning">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∞–≤—Ç–æ—Ä–∞</button>
        <button onclick="viewSubscriptions('{{ post.author_id }}')" class="btn btn-info">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</button>
    </div>

    <div class="comments">
        <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments|length }})</h3>
        
        <div class="comment-form">
            <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</h4>
            <select id="commentAuthor" style="margin-bottom: 10px; padding: 5px; display: block;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.login }}</option>
                {% endfor %}
            </select>
            <textarea id="commentContent" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3"></textarea>
            <button onclick="addComment('{{ post.id }}')" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </div>

        <div id="commentsList">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-meta">
                    <strong>{{ comment.author_name }}</strong> | {{ comment.created_at[:16] }}
                </div>
                <div style="margin: 8px 0;">{{ comment.content }}</div>
                <button onclick="deleteComment('{{ comment.id }}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #dc3545; color: white;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            {% else %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
            {% endfor %}
        </div>
    </div>

    <script>
        async function addComment(postId) {
            const authorId = document.getElementById('commentAuthor').value;
            const content = document.getElementById('commentContent').value;
            
            if (!authorId || !content) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!');
                return;
            }

            try {
                const response = await fetch('/api/comments/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        post_id: parseInt(postId),
                        user_id: parseInt(authorId),
                        content: content
                    })
                });
                
                if (response.ok) {
                    alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;
            
            try {
                const response = await fetch('/api/comments/' + commentId, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω!');
                    location.reload();
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function addToFavorites(postId) {
            const userId = document.getElementById('favoriteUser').value;
            if (!userId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
                return;
            }

            try {
                const response = await fetch('/api/favorites/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        post_id: parseInt(postId)
                    })
                });
                
                if (response.ok) {
                    alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!');
                    document.getElementById('favoriteUser').value = '';
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function subscribeToAuthor(authorId) {
            const userId = document.getElementById('subscriberUser').value;
            if (!userId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!');
                return;
            }

            try {
                const response = await fetch('/api/subscriptions/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscriber_id: parseInt(userId),
                        target_user_id: parseInt(authorId)
                    })
                });
                
                if (response.ok) {
                    alert('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!');
                    document.getElementById('subscriberUser').value = '';
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + error.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function viewSubscriptions(authorId) {
            try {
                const response = await fetch('/api/users/' + authorId + '/subscribers');
                const subscribers = await response.json();
                
                let message = '–ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –∞–≤—Ç–æ—Ä–∞:\n';
                if (subscribers.length > 0) {
                    subscribers.forEach(sub => {
                        message += `- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${sub.subscriber_id}\n`;
                    });
                } else {
                    message += '–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤';
                }
                alert(message);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
    </script>
</body>
</html>